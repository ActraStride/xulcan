# ==============================================================================
# XULCAN ORCHESTRATION MANIFEST — LOCAL/DEV ENVIRONMENT
# ==============================================================================
#
# Topology:  Microservices architecture with centralized data persistence.
# Network:   Isolated bridge network; databases are not exposed externally.
# Storage:   Named volumes ensure data durability across container restarts.
# Security:  Credentials managed via Docker Secrets (file-based for local dev).
#
# ==============================================================================

services:

  # ============================================================================
  # === DATA LAYER =============================================================
  # ============================================================================

  # ----------------------------------------------------------------------------
  # [DATA] PostgreSQL — Primary Relational Datastore
  # ----------------------------------------------------------------------------
  # Serve as the main RDBMS for persistent application data.
  # Credentials are injected via Docker Secrets, not environment variables.
  postgres:
    image: postgres:16.11-alpine
    container_name: xulcan-postgres
    restart: unless-stopped
    # [OPS] Allocate shared memory for PostgreSQL performance optimization.
    shm_size: 128mb
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-xulcan}
      # [SEC] Read database password from a mounted secret file.
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: ${POSTGRES_DB:-xulcan_db}
      # Enforce UTF-8 encoding and a consistent C locale for portability.
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C.UTF-8"
    volumes:
      # Persist database files across container restarts.
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Expose PostgreSQL on a non-standard host port (default: 55432).
      - "${POSTGRES_PORT:-55432}:5432"
    healthcheck:
      # Verify PostgreSQL is accepting connections before dependent services start.
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-xulcan} -d ${POSTGRES_DB:-xulcan_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - xulcan-net
    # [OPS] Reusable logging configuration anchor.
    logging: &default-logging
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    secrets:
      - postgres_password

  # ----------------------------------------------------------------------------
  # [DATA] Redis — Ephemeral/State Store (Bitnami Edition)
  # ----------------------------------------------------------------------------
  # Provide in-memory caching and state management.
  # Use Bitnami image for native secret file support (avoids shell wrapper issues).
  redis:
    # [SEC] Pin image with SHA256 digest for supply-chain security.
    # Update digest when upgrading the Redis version.
    image: bitnami/redis:7.2.4@sha256:c9fe12d04ead99c483a030768aa80b3bb8a96d254bb6d02d0fb30374c53077e1
    container_name: xulcan-redis
    restart: unless-stopped
    environment:
      # [SEC] Bitnami natively supports reading passwords from secret files.
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      # Enable Append-Only File persistence for data durability.
      - REDIS_AOF_ENABLED=yes
    volumes:
      # [OPS] Bitnami uses /bitnami/redis/data as the data directory.
      - redis_data:/bitnami/redis/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      # Authenticate and verify Redis responds to PING.
      test: ["CMD-SHELL", "REDISCLI_AUTH=$(cat /run/secrets/redis_password) redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - xulcan-net
    logging: *default-logging
    secrets:
      - redis_password

  # ============================================================================
  # === APPLICATION LAYER ======================================================
  # ============================================================================

  # ----------------------------------------------------------------------------
  # [APP] FastAPI — Core API Service
  # ----------------------------------------------------------------------------
  # Serve the primary application API. Build from local Dockerfile.
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Include development dependencies in the image.
        INSTALL_DEV: "true"
    container_name: xulcan-core
    restart: unless-stopped
    # [OPS] Enable init process for proper signal handling and zombie reaping.
    init: true
    env_file:
      # Load non-sensitive configuration from environment file.
      - .env.example
    environment:
      # [SEC] Database URLs exclude passwords; application reads secrets at runtime.
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-xulcan}@postgres:5432/${POSTGRES_DB:-xulcan_db}
      - REDIS_URL=redis://redis:6379/0
      # [SEC] Paths to mounted secret files for credential retrieval.
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PYTHONPATH=/app
    volumes:
      # Mount source code for live reloading during development.
      - ./app:/app/app:rw
      - ./tests:/app/tests:rw
    ports:
      - "${APP_PORT:-8000}:8000"
    depends_on:
      # Wait for healthy database services before starting.
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - xulcan-net
    # Run Uvicorn with hot-reload enabled for development.
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --log-level ${LOG_LEVEL:-info}
    healthcheck:
      # Invoke healthcheck script using the container's virtual environment.
      test: ["CMD", "/app/.venv/bin/python", "app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging: *default-logging
    secrets:
      - postgres_password
      - redis_password

  # ============================================================================
  # === DEVELOPER TOOLS ========================================================
  # ============================================================================

  # ----------------------------------------------------------------------------
  # [TOOL] pgAdmin — PostgreSQL Administration Interface
  # ----------------------------------------------------------------------------
  # Provide a web-based GUI for database management (dev profile only).
  pgadmin:
    image: dpage/pgadmin4:9.10
    container_name: xulcan-pgadmin
    restart: unless-stopped
    profiles: ["dev"]
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@xulcan.dev}
      # [SEC] Read admin password from mounted secret file.
      PGADMIN_DEFAULT_PASSWORD_FILE: /run/secrets/pgadmin_password
      # Disable server mode for simplified local access.
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    networks:
      - xulcan-net
    logging: *default-logging
    secrets:
      - pgadmin_password

  # ----------------------------------------------------------------------------
  # [TOOL] Redis Insight — Redis Administration Interface
  # ----------------------------------------------------------------------------
  # Provide a web-based GUI for Redis inspection and management (dev profile only).
  # Connection credentials are configured via the UI and persisted in a volume.
  redis-insight:
    image: redis/redisinsight:2.44.0
    container_name: xulcan-redis-ui
    restart: unless-stopped
    profiles: ["dev"]
    volumes:
      - redis_insight_data:/data
    ports:
      # Default Redis Insight port.
      - "${REDIS_INSIGHT_PORT:-5540}:5540"
    networks:
      - xulcan-net
    logging: *default-logging

# ==============================================================================
# === INFRASTRUCTURE ===========================================================
# ==============================================================================

# --- Networks -----------------------------------------------------------------
networks:
  xulcan-net:
    driver: bridge
    name: xulcan-network

# --- Volumes ------------------------------------------------------------------
volumes:
  postgres_data:
    name: xulcan-postgres-data
  redis_data:
    name: xulcan-redis-data
  pgadmin_data:
    name: xulcan-pgadmin-data
  redis_insight_data:
    name: xulcan-redis-insight-data

# --- Secrets ------------------------------------------------------------------
# [SEC] For local development, secrets are read from files in ./.secrets/.
#       In production (Docker Swarm), use 'external: true' instead.
secrets:
  postgres_password:
    file: ./.secrets/postgres_password
  redis_password:
    file: ./.secrets/redis_password
  pgadmin_password:
    file: ./.secrets/pgadmin_password